name: Validation Checks
on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  checks:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/install-node

      - name: Install dependencies
        run: npm ci

      - name: Run Type Check
        run: npm run typescript

      - name: Run Unit Tests
        run: npm run test-ci

      - name: Run Linter
        run: npm run lint

      - name: Run Formatter
        run: npm run format

      - name: Run react-native bundle
        run: npm run test:bundle

      - name: Add coverage to job summary (with emojis)
        run: |
          emoji () {
            pct=$1
            if (( $(echo "$pct >= 90" | bc -l) )); then echo "ðŸŸ¢";
            elif (( $(echo "$pct >= 80" | bc -l) )); then echo "ðŸŸ¡";
            else echo "ðŸ”´"; fi
          }

          echo "## ðŸ§ª Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY

          jq -r '.total | to_entries[] | select(.value != null) | "\(.key) \(.value.pct)"' coverage/coverage-final.json \
          | while read metric pct; do
              printf "| %s | %.1f%% | %s |\n" \
                "$(echo $metric | sed 's/.*/\u&/')" \
                "$pct" \
                "$(emoji $pct)" \
                >> $GITHUB_STEP_SUMMARY
            done
